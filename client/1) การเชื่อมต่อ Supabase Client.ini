1) การเชื่อมต่อ Supabase Client
ใช้ไฟล์ lib/supabase.js เดียวเท่านั้น และต้องอ่านคีย์จาก ENV เท่านั้น
ห้ามฮาร์ดโค้ด URL/ANON_KEY ลงในไฟล์โค้ดที่คอมมิต
เปิด persistSession และ autoRefreshToken
ตัวอย่างสั้นที่ควรใช้ใน lib/supabase.js:

SUPABASE_URL จาก VITE_SUPABASE_URL
SUPABASE_ANON_KEY จาก VITE_SUPABASE_ANON_KEY
persistSession: true, autoRefreshToken: true
2) การอ่านข้อมูลแบบสาธารณะ (Lazy Auth)
หน้า “รายการรถ” ต้องดึงข้อมูลจากตาราง vehicles แบบ Public SELECT ได้เลย (ไม่บังคับล็อกอิน)
รองรับฟิลเตอร์ category/status และ pagination
ห้ามพยายามเขียน/แก้ไข vehicles จากฝั่งหน้า ถ้าไม่ใช่แอดมิน/สตาฟ
คำขอที่ควรส่งให้ฝั่งหน้า:

สร้างฟังก์ชัน fetchVehicles({ category?, status?, page?, limit? }) พร้อม fallback เมื่อเน็ตสะดุด
จัดทำสถานะ loading/error อย่างชัดเจน
ทำ index-based filters ใน UI ให้สอดคล้องกับ category/status
3) โฟลว์การจอง (Confirm Booking)
เมื่อผู้ใช้กด Confirm:
เช็ก session; ถ้าไม่มี ให้พาไปล็อกอิน แล้ว redirect กลับหน้าจองเดิม (เก็บ state ของวันที่และรถที่เลือกไว้ใน URL หรือ Zustand)
ถ้ามี session: เรียก insert ลง reservations ด้วยค่าต่อไปนี้:
user_id = session.user.id
vehicle_id, pickup_date, dropoff_date
ไม่ต้องส่ง total_price เพราะฝั่ง DB คำนวณให้
จัดการ error: ถ้าเจอ “Overlapping reservation exists” ให้แสดงข้อความสุภาพ และชวนเปลี่ยนวันที่
คำขอที่ควรส่งให้ฝั่งหน้า:

ทำ helper createReservation({ vehicle_id, pickup_date, dropoff_date })
handle redirect-after-login อย่างถูกต้อง (เช่น query param redirectTo, หรือ Zustand เก็บ intended action)
4) หน้าผู้ใช้ (My Reservations)
ดึงเฉพาะรายการของผู้ใช้ปัจจุบัน (RLS จำกัดให้แล้ว)
รองรับอัปเดตสถานะที่ผู้ใช้ทำเองได้ (เช่น cancel) ถ้าธุรกิจอนุญาต
ใช้ Realtime subscription เพื่ออัปเดตสถานะทันทีเมื่อแอดมินอนุมัติ/ยกเลิก
คำขอที่ควรส่งให้ฝั่งหน้า:

เพิ่ม hook/useReservationRealtime ที่สมัคร channel ชื่อ reservation:<user_id>:updates แบบ private
เมื่อได้รับ event status_changed ให้รีเฟรชรายการใน store หรือตัวที่เปลี่ยนเท่านั้น
5) แดชบอร์ดแอดมิน
แสดงตาราง reservations พร้อมฟิลเตอร์ status และช่วงวันที่
ปุ่ม “Approve/Cancel/Complete” เรียก update status ได้ (RLS อนุญาตเฉพาะ staff/super_admin)
ใช้ Realtime channel admin:reservations เพื่อลดการรีเฟรชบ่อย
คำขอที่ควรส่งให้ฝั่งหน้า:

ทำ hook/useAdminReservationsRealtime สำหรับรับ event reservation_updated
ทำ optimistic UI แต่ต้อง rollback หาก update ล้มเหลว
6) Zustand Store และการจัดการสถานะ
ใช้ store กลางเก็บ session/profiles และรายการรถ/การจอง
แยก slice ชัดเจน เช่น sessionSlice, vehiclesSlice, reservationsSlice
มี action สำหรับ:
setUser/session
setProfile
setVehicles, setReservations
updateReservationById (สำหรับอัปเดตเฉพาะรายการเมื่อได้รับ Realtime)
คำขอที่ควรส่งให้ฝั่งหน้า:

ไม่กระจายคำสั่ง supabase ไปทั่วคอมโพเนนต์ ให้ผ่าน adapter/helper functions แทน (vehicles.js, reservations.js)
มี cleanup ทุกครั้งที่ subscribe channel
7) ความปลอดภัยฝั่งหน้า
ห้ามใช้ service_role key ใน frontend เด็ดขาด
ทุก operation ที่ต้องการสิทธิ์สูงให้ทำผ่าน RLS + user session เท่านั้น
validation ฝั่งหน้าเป็นเพียงชั้น UX; ความจริงให้เชื่อ DB/Triggers เป็นหลัก
ซ่อนข้อมูลที่ UI ไม่จำเป็นต้องแสดง (เช่น user_id ของคนอื่น)
คำขอที่ควรส่งให้ฝั่งหน้า:

ตรวจสอบว่าไม่มีการเปิดเผย env key ที่สำคัญใน bundle
ใช้ HTTPS และตรวจสอบ error จาก Supabase เสมอ
8) การแสดงราคาและคำนวณราคา
ฝั่งหน้า: แสดงราคาแบบ preview (days * price_per_day) เพื่อ UX ที่ดี
ฝั่งหลังบ้าน: ราคา final มาจาก Trigger เท่านั้น
หากราคา preview ต่างจาก final ให้ UI อัปเดตตามค่าจริงหลัง insert สำเร็จ*
คำขอที่ควรส่งให้ฝั่งหน้า:

แยกฟังก์ชัน calculatePreviewPrice เพื่อให้สอดคล้องกับฝั่งหลังบ้าน
หลัง insert สำเร็จ ให้ใช้ค่าจาก row ที่ได้กลับมาจริง
9) การจัดการเวลา/โซนเวลา
ใช้ ISO 8601 และส่งค่าเป็น UTC เสมอ
ระบุ timezone ใน UI ชัดเจนถ้ามีความต้องการพิเศษ
คำขอที่ควรส่งให้ฝั่งหน้า:

ทุกวันที่ส่งไปเป็น timestamptz (new Date().toISOString())
แปลงและแสดงผลในโซนเวลาผู้ใช้ด้วย dayjs/date-fns ถ้าต้องการ
10) Error handling และ UX
แยก Error ยุทธศาสตร์:
Auth required -> แจ้งให้ล็อกอิน
Overlap -> ให้ผู้ใช้เลือกวันใหม่
Permission denied -> แสดงว่าไม่มีสิทธิ์ดำเนินการ
มี retry/backoff สำหรับเน็ตสะดุด
คำขอที่ควรส่งให้ฝั่งหน้า:

สร้าง error mapper จาก Supabase error -> UI message ที่เข้าใจง่าย
ทำ Toast/Modal สำหรับแจ้งเหตุเร่งด่วน (เช่น สถานะเปลี่ยน)
